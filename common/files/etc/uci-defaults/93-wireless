set -x

. /root/.env

wifi_enable_device() {
  local cfg="$1"

  uci set wireless.$cfg.disabled='0'
}

wifi_setup_interface() {
  local cfg="$1"

  uci set wireless.$cfg.ssid="$OP_WIRELESS_SSID"
  if [ -n "$OP_WIRELESS_PASSWORD" -a "${#OP_WIRELESS_PASSWORD}" -ge 8 ]; then
    uci set wireless.$cfg.key="$OP_WIRELESS_PASSWORD"
    uci set wireless.$cfg.encryption="psk2"
  else
    uci set wireless.$cfg.encryption="none"
  fi
}

wifi_roaming_device() {
  local cfg="$1"

  uci set wireless.$cfg.cell_density='0'
}

wifi_roaming_interface() {
  local cfg="$1"

  uci set wireless.$cfg.ieee80211r='1'
  uci set wireless.$cfg.ft_over_ds='0'
  uci set wireless.$cfg.ft_psk_generate_local='1'
}

config_load wireless
config_foreach wifi_enable_device wifi-device
config_foreach wifi_setup_interface wifi-iface
if [ "$OP_WIRELESS_ROAMING" = "true" ]; then
  config_foreach wifi_roaming_device wifi-device
  config_foreach wifi_roaming_interface wifi-iface
fi
uci commit wireless


# TODO guest
